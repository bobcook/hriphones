/*!
 * Pusher JavaScript Library v1.12.5
 * http://pusherapp.com/
 *
 * Copyright 2011, Pusher
 * Released under the MIT licence.
 */
(function(){void 0===Function.prototype.scopedTo&&(Function.prototype.scopedTo=function(e,t){var n=this;return function(){return n.apply(e,Array.prototype.slice.call(t||[]).concat(Array.prototype.slice.call(arguments)))}});var e=function(t,n){this.options=n||{},this.key=t,this.channels=new e.Channels,this.global_emitter=new e.EventsDispatcher;var i=this;this.checkAppKey(),this.connection=new e.Connection(this.key,this.options),this.connection.bind("connected",function(){i.subscribeAll()}).bind("message",function(e){var t=0===e.event.indexOf("pusher_internal:");if(e.channel){var n;(n=i.channel(e.channel))&&n.emit(e.event,e.data)}t||i.global_emitter.emit(e.event,e.data)}).bind("disconnected",function(){i.channels.disconnect()}).bind("error",function(t){e.warn("Error",t)}),e.instances.push(this),e.isReady&&i.connect()};e.instances=[],e.prototype={channel:function(e){return this.channels.find(e)},connect:function(){this.connection.connect()},disconnect:function(){this.connection.disconnect()},bind:function(e,t){return this.global_emitter.bind(e,t),this},bind_all:function(e){return this.global_emitter.bind_all(e),this},subscribeAll:function(){for(channelName in this.channels.channels)this.channels.channels.hasOwnProperty(channelName)&&this.subscribe(channelName)},subscribe:function(e){var t=this,n=this.channels.add(e,this);return"connected"===this.connection.state&&n.authorize(this.connection.socket_id,this.options,function(i,s){i?n.emit("pusher:subscription_error",s):t.send_event("pusher:subscribe",{channel:e,auth:s.auth,channel_data:s.channel_data})}),n},unsubscribe:function(e){this.channels.remove(e),"connected"===this.connection.state&&this.send_event("pusher:unsubscribe",{channel:e})},send_event:function(e,t,n){return this.connection.send_event(e,t,n)},checkAppKey:function(){(null===this.key||void 0===this.key)&&e.warn("Warning","You must pass your app key when you instantiate Pusher.")}},e.Util={extend:function t(e,n){for(var i in n)e[i]=n[i]&&n[i].constructor&&n[i].constructor===Object?t(e[i]||{},n[i]):n[i];return e},stringify:function(){for(var e=["Pusher"],t=0;t<arguments.length;t++)"string"==typeof arguments[t]?e.push(arguments[t]):void 0==window.JSON?e.push(arguments[t].toString()):e.push(JSON.stringify(arguments[t]));return e.join(" : ")},arrayIndexOf:function(e,t){var n=Array.prototype.indexOf;if(null==e)return-1;if(n&&e.indexOf===n)return e.indexOf(t);for(i=0,l=e.length;l>i;i++)if(e[i]===t)return i;return-1}},e.debug=function(){e.log&&e.log(e.Util.stringify.apply(this,arguments))},e.warn=function(){if(window.console&&window.console.warn)window.console.warn(e.Util.stringify.apply(this,arguments));else{if(!e.log)return;e.log(e.Util.stringify.apply(this,arguments))}},e.VERSION="1.12.5",e.host="ws.pusherapp.com",e.ws_port=80,e.wss_port=443,e.sockjs_host="sockjs.pusher.com",e.sockjs_http_port=80,e.sockjs_https_port=443,e.sockjs_path="/pusher",e.channel_auth_endpoint="/pusher/auth",e.cdn_http="http://js.pusher.com/",e.cdn_https="https://d3dy5gmtp8yhk7.cloudfront.net/",e.dependency_suffix="",e.channel_auth_transport="ajax",e.activity_timeout=12e4,e.pong_timeout=3e4,e.isReady=!1,e.ready=function(){e.isReady=!0;for(var t=0,n=e.instances.length;n>t;t++)e.instances[t].connect()},this.Pusher=e}).call(this),function(){function e(){this._callbacks={}}function t(t){this.callbacks=new e,this.global_callbacks=[],this.failThrough=t}e.prototype.get=function(e){return this._callbacks[this._prefix(e)]},e.prototype.add=function(e,t){var n=this._prefix(e);this._callbacks[n]=this._callbacks[n]||[],this._callbacks[n].push(t)},e.prototype.remove=function(e,t){if(this.get(e)){var n=Pusher.Util.arrayIndexOf(this.get(e),t);this._callbacks[this._prefix(e)].splice(n,1)}},e.prototype._prefix=function(e){return"_"+e},t.prototype.bind=function(e,t){return this.callbacks.add(e,t),this},t.prototype.unbind=function(e,t){return this.callbacks.remove(e,t),this},t.prototype.emit=function(e,t){for(var n=0;n<this.global_callbacks.length;n++)this.global_callbacks[n](e,t);var i=this.callbacks.get(e);if(i)for(var n=0;n<i.length;n++)i[n](t);else this.failThrough&&this.failThrough(e,t);return this},t.prototype.bind_all=function(e){return this.global_callbacks.push(e),this},this.Pusher.EventsDispatcher=t}.call(this),function(){function e(e){return e.substr(0,1).toUpperCase()+e.substr(1)}function t(e,t,n){void 0!==t[e]&&t[e](n)}function n(e,t,n){i.EventsDispatcher.call(this),this.state=void 0,this.errors=[],this.stateActions=n,this.transitions=t,this.transition(e)}var i=this.Pusher;n.prototype.transition=function(n,s){var o=this.state,a=this.stateActions;if(o&&-1==i.Util.arrayIndexOf(this.transitions[o],n))throw this.emit("invalid_transition_attempt",{oldState:o,newState:n}),new Error("Invalid transition ["+o+" to "+n+"]");t(o+"Exit",a,s),t(o+"To"+e(n),a,s),t(n+"Pre",a,s),this.state=n,this.emit("state_change",{oldState:o,newState:n}),t(n+"Post",a,s)},n.prototype.is=function(e){return this.state===e},n.prototype.isNot=function(e){return this.state!==e},i.Util.extend(n.prototype,i.EventsDispatcher.prototype),this.Pusher.Machine=n}.call(this),function(){var e=function(){var e=this;Pusher.EventsDispatcher.call(this),void 0!==window.addEventListener&&(window.addEventListener("online",function(){e.emit("online",null)},!1),window.addEventListener("offline",function(){e.emit("offline",null)},!1))};e.prototype.isOnLine=function(){return void 0===window.navigator.onLine?!0:window.navigator.onLine},Pusher.Util.extend(e.prototype,Pusher.EventsDispatcher.prototype),this.Pusher.NetInfo=e}.call(this),function(){function e(e){e.connectionWait=0,e.openTimeout="native"===n.TransportType?4e3:"flash"===n.TransportType?7e3:6e3,e.connectedTimeout=2e3,e.connectionSecure=e.compulsorySecure,e.failedAttempts=0}function t(t,c){function l(){C.openTimeout<a&&(C.openTimeout+=s),C.connectedTimeout<r&&(C.connectedTimeout+=o),C.compulsorySecure!==!0&&(C.connectionSecure=!C.connectionSecure),C.failedAttempts++}function h(e){var t=e||"https:"===document.location.protocol,i=t?n.wss_port:n.ws_port,s=t?"wss://":"ws://";return s+n.host+":"+i}function u(e){var t="flash"===n.TransportType?"true":"false",i="/app/"+e+"?protocol=5&client=js&version="+n.VERSION+"&flash="+t;return i}function d(e){var t=e||"https:"===document.location.protocol,i=t?n.sockjs_https_port:n.sockjs_http_port,s=t?"https://":"http://";return s+n.sockjs_host+":"+i+n.sockjs_path}function p(){C._machine.transition("impermanentlyClosing")}function f(){C._activityTimer&&clearTimeout(C._activityTimer),C.ping&&(C._activityTimer=setTimeout(function(){C.send_event("pusher:ping",{}),C._activityTimer=setTimeout(function(){C.socket.close()},C.options.pong_timeout||n.pong_timeout)},C.options.activity_timeout||n.activity_timeout))}function g(){C._activityTimer&&clearTimeout(C._activityTimer)}function _(){var e=C.connectionWait;if(0===e&&C.connectedAt){var t=1e3,n=(new Date).getTime()-C.connectedAt;t>n&&(e=t-n)}return e}function m(e,t){C.emit("error",{type:"PusherError",data:{code:e,message:t}}),4e3===e?(C.compulsorySecure=!0,C.connectionSecure=!0,C.options.encrypted=!0,p()):4100>e?C._machine.transition("permanentlyClosing"):4200>e?(C.connectionWait=1e3,C._machine.transition("waiting")):4300>e?p():C._machine.transition("permanentlyClosing")}function y(e){var t=w(e);void 0!==t&&("pusher:connection_established"===t.event?C._machine.transition("connected",t.data.socket_id):"pusher:error"===t.event&&m(t.data.code,t.data.message))}function v(e){f();var t=w(e);if(void 0!==t){switch(n.debug("Event recd",t),t.event){case"pusher:error":C.emit("error",{type:"PusherError",data:t.data});break;case"pusher:ping":C.send_event("pusher:pong",{})}C.emit("message",t)}}function w(e){try{var t=JSON.parse(e.data);if("string"==typeof t.data)try{t.data=JSON.parse(t.data)}catch(n){if(!(n instanceof SyntaxError))throw n}return t}catch(n){C.emit("error",{type:"MessageParseError",error:n,data:e.data})}}function b(){C._machine.transition("waiting")}function T(e){C.emit("error",{type:"WebSocketError",error:e})}function S(e,t){var i=C.state;C.state=e,i!==e&&(n.debug("State changed",i+" -> "+e),C.emit("state_change",{previous:i,current:e}),C.emit(e,t))}var C=this;n.EventsDispatcher.call(this),this.ping=!0,this.options=n.Util.extend({encrypted:!1},c),this.netInfo=new n.NetInfo,this.netInfo.bind("online",function(){C._machine.is("waiting")&&(C._machine.transition("connecting"),S("connecting"))}),this.netInfo.bind("offline",function(){C._machine.is("connected")&&(C.socket.onclose=void 0,C.socket.onmessage=void 0,C.socket.onerror=void 0,C.socket.onopen=void 0,C.socket.close(),C.socket=void 0,C._machine.transition("waiting"))}),this._machine=new n.Machine("initialized",i,{initializedPre:function(){C.compulsorySecure=C.options.encrypted,C.key=t,C.socket=null,C.socket_id=null,C.state="initialized"},waitingPre:function(){C.netInfo.isOnLine()?(C.failedAttempts<2?S("connecting"):(S("unavailable"),C.connectionWait=1e4),C.connectionWait>0&&C.emit("connecting_in",_()),C._waitingTimer=setTimeout(function(){C._machine.transition("connecting")},_())):S("unavailable")},waitingExit:function(){clearTimeout(C._waitingTimer)},connectingPre:function(){if(C.netInfo.isOnLine()===!1)return C._machine.transition("waiting"),S("unavailable"),void 0;var e=u(C.key);if("sockjs"===n.TransportType){n.debug("Connecting to sockjs",n.sockjs);var t=d(C.connectionSecure);C.ping=!1,C.socket=new SockJS(t),C.socket.onopen=function(){C.socket.send(JSON.stringify({path:e})),C._machine.transition("open")}}else{var t=h(C.connectionSecure)+e;n.debug("Connecting",t),C.socket=new n.Transport(t),C.socket.onopen=function(){C._machine.transition("open")}}C.socket.onclose=b,C.socket.onerror=T,C._connectingTimer=setTimeout(p,C.openTimeout)},connectingExit:function(){clearTimeout(C._connectingTimer),C.socket.onopen=void 0},connectingToWaiting:function(){l()},connectingToImpermanentlyClosing:function(){l()},openPre:function(){C.socket.onmessage=y,C.socket.onerror=T,C.socket.onclose=b,C._openTimer=setTimeout(p,C.connectedTimeout)},openExit:function(){clearTimeout(C._openTimer),C.socket.onmessage=void 0},openToWaiting:function(){l()},openToImpermanentlyClosing:function(){l()},connectedPre:function(t){C.socket_id=t,C.socket.onmessage=v,C.socket.onerror=T,C.socket.onclose=b,e(C),C.connectedAt=(new Date).getTime(),f()},connectedPost:function(){S("connected")},connectedExit:function(){g(),S("disconnected")},impermanentlyClosingPost:function(){C.socket&&(C.socket.onclose=b,C.socket.close())},permanentlyClosingPost:function(){C.socket?(C.socket.onclose=function(){e(C),C._machine.transition("permanentlyClosed")},C.socket.close()):(e(C),C._machine.transition("permanentlyClosed"))},failedPre:function(){S("failed"),n.debug("WebSockets are not available in this browser.")},permanentlyClosedPost:function(){S("disconnected")}})}var n=this.Pusher,i={initialized:["waiting","failed"],waiting:["connecting","permanentlyClosed"],connecting:["open","permanentlyClosing","impermanentlyClosing","waiting"],open:["connected","permanentlyClosing","impermanentlyClosing","waiting"],connected:["permanentlyClosing","waiting"],impermanentlyClosing:["waiting","permanentlyClosing"],permanentlyClosing:["permanentlyClosed"],permanentlyClosed:["waiting","failed"],failed:["permanentlyClosed"]},s=2e3,o=2e3,a=1e4,r=1e4;t.prototype.connect=function(){this._machine.is("failed")||n.Transport?this._machine.is("initialized")?(e(this),this._machine.transition("waiting")):this._machine.is("waiting")&&this.netInfo.isOnLine()===!0?this._machine.transition("connecting"):this._machine.is("permanentlyClosed")&&(e(this),this._machine.transition("waiting")):this._machine.transition("failed")},t.prototype.send=function(e){if(this._machine.is("connected")){var t=this;return setTimeout(function(){t.socket.send(e)},0),!0}return!1},t.prototype.send_event=function(e,t,i){var s={event:e,data:t};return i&&(s.channel=i),n.debug("Event sent",s),this.send(JSON.stringify(s))},t.prototype.disconnect=function(){this._machine.is("permanentlyClosed")||(this._machine.is("waiting")||this._machine.is("failed")?this._machine.transition("permanentlyClosed"):this._machine.transition("permanentlyClosing"))},n.Util.extend(t.prototype,n.EventsDispatcher.prototype),this.Pusher.Connection=t}.call(this),function(){Pusher.Channels=function(){this.channels={}},Pusher.Channels.prototype={add:function(e,t){var n=this.find(e);if(n)return n;var i=Pusher.Channel.factory(e,t);return this.channels[e]=i,i},find:function(e){return this.channels[e]},remove:function(e){delete this.channels[e]},disconnect:function(){for(var e in this.channels)this.channels[e].disconnect()}},Pusher.Channel=function(e,t){var n=this;Pusher.EventsDispatcher.call(this,function(t){Pusher.debug("No callbacks on "+e+" for "+t)}),this.pusher=t,this.name=e,this.subscribed=!1,this.bind("pusher_internal:subscription_succeeded",function(e){n.onSubscriptionSucceeded(e)})},Pusher.Channel.prototype={init:function(){},disconnect:function(){this.subscribed=!1,this.emit("pusher_internal:disconnected")},onSubscriptionSucceeded:function(){this.subscribed=!0,this.emit("pusher:subscription_succeeded")},authorize:function(e,t,n){return n(!1,{})},trigger:function(e,t){return this.pusher.send_event(e,t,this.name)}},Pusher.Util.extend(Pusher.Channel.prototype,Pusher.EventsDispatcher.prototype),Pusher.Channel.PrivateChannel={authorize:function(e,t,n){var i=this,s=new Pusher.Channel.Authorizer(this,Pusher.channel_auth_transport,t);return s.authorize(e,function(e,t){e||i.emit("pusher_internal:authorized",t),n(e,t)})}},Pusher.Channel.PresenceChannel={init:function(){this.members=new e(this)},onSubscriptionSucceeded:function(){this.subscribed=!0}};var e=function(e){var t=this,n=function(){this._members_map={},this.count=0,this.me=null};n.call(this),e.bind("pusher_internal:authorized",function(n){var i=JSON.parse(n.channel_data);e.bind("pusher_internal:subscription_succeeded",function(n){t._members_map=n.presence.hash,t.count=n.presence.count,t.me=t.get(i.user_id),e.emit("pusher:subscription_succeeded",t)})}),e.bind("pusher_internal:member_added",function(n){null===t.get(n.user_id)&&t.count++,t._members_map[n.user_id]=n.user_info,e.emit("pusher:member_added",t.get(n.user_id))}),e.bind("pusher_internal:member_removed",function(n){var i=t.get(n.user_id);i&&(delete t._members_map[n.user_id],t.count--,e.emit("pusher:member_removed",i))}),e.bind("pusher_internal:disconnected",function(){n.call(t)})};e.prototype={each:function(e){for(var t in this._members_map)e(this.get(t))},get:function(e){return this._members_map.hasOwnProperty(e)?{id:e,info:this._members_map[e]}:null}},Pusher.Channel.factory=function(e,t){var n=new Pusher.Channel(e,t);return 0===e.indexOf("private-")?Pusher.Util.extend(n,Pusher.Channel.PrivateChannel):0===e.indexOf("presence-")&&(Pusher.Util.extend(n,Pusher.Channel.PrivateChannel),Pusher.Util.extend(n,Pusher.Channel.PresenceChannel)),n.init(),n}}.call(this),function(){Pusher.Channel.Authorizer=function(e,t,n){this.channel=e,this.type=t,this.authOptions=(n||{}).auth||{}},Pusher.Channel.Authorizer.prototype={composeQuery:function(e){var t="&socket_id="+encodeURIComponent(e)+"&channel_name="+encodeURIComponent(this.channel.name);for(var n in this.authOptions.params)t+="&"+encodeURIComponent(n)+"="+encodeURIComponent(this.authOptions.params[n]);return t},authorize:function(e,t){return Pusher.authorizers[this.type].call(this,e,t)}},Pusher.auth_callbacks={},Pusher.authorizers={ajax:function(e,t){var n;n=Pusher.XHR?new Pusher.XHR:window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.open("POST",Pusher.channel_auth_endpoint,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(var i in this.authOptions.headers)n.setRequestHeader(i,this.authOptions.headers[i]);return n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status){var e,i=!1;try{e=JSON.parse(n.responseText),i=!0}catch(s){t(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+n.responseText)}i&&t(!1,e)}else Pusher.warn("Couldn't get auth info from your webapp",n.status),t(!0,n.status)},n.send(this.composeQuery(e)),n},jsonp:function(e,t){void 0!==this.authOptions.headers&&Pusher.warn("Warn","To send headers with the auth request, you must use AJAX, rather than JSONP.");var n=document.createElement("script");Pusher.auth_callbacks[this.channel.name]=function(e){t(!1,e)};var i="Pusher.auth_callbacks['"+this.channel.name+"']";n.src=Pusher.channel_auth_endpoint+"?callback="+encodeURIComponent(i)+this.composeQuery(e);var s=document.getElementsByTagName("head")[0]||document.documentElement;s.insertBefore(n,s.firstChild)}}}.call(this);var _require=function(){function e(e,t){document.addEventListener?e.addEventListener("load",t,!1):e.attachEvent("onreadystatechange",function(){("loaded"==e.readyState||"complete"==e.readyState)&&t()})}function t(t,n){var i=document.getElementsByTagName("head")[0],s=document.createElement("script");s.setAttribute("src",t),s.setAttribute("type","text/javascript"),s.setAttribute("async",!0),e(s,function(){n()}),i.appendChild(s)}return function(e,n){for(var i=0,s=0;s<e.length;s++)t(e[s],function(){e.length==++i&&setTimeout(n,0)})}}();!function(){!window.WebSocket&&window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),window.WebSocket&&(Pusher.Transport=window.WebSocket,Pusher.TransportType="native");var e="http:"==document.location.protocol?Pusher.cdn_http:Pusher.cdn_https,t=e+Pusher.VERSION,n=[];window.JSON||n.push(t+"/json2"+Pusher.dependency_suffix+".js"),window.WebSocket||(window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=!0,window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0,n.push(t+"/flashfallback"+Pusher.dependency_suffix+".js"));var i=function(){return window.WebSocket?function(){Pusher.ready()}:function(){window.WebSocket?(Pusher.Transport=window.WebSocket,Pusher.TransportType="flash",window.WEB_SOCKET_SWF_LOCATION=t+"/WebSocketMain.swf",WebSocket.__addTask(function(){Pusher.ready()}),WebSocket.__initialize()):(sockjsPath=t+"/sockjs"+Pusher.dependency_suffix+".js",_require([sockjsPath],function(){Pusher.Transport=SockJS,Pusher.TransportType="sockjs",Pusher.ready()}))}}(),s=function(e){var t=function(){document.body?e():setTimeout(t,0)};t()},o=function(){s(i)};n.length>0?_require(n,o):o()}(),function(){this.JST||(this.JST={}),this.JST["templates/telephony/agents_view"]=function(obj){var __p=[];with(obj||{})__p.push('<ol class="agents-list">\n  '),agents.each(function(e){__p.push('\n    <li class="',e.status(),'" data-id="',e.id,'">\n      <span class="icon-user ',e.status(),'"></span>\n      ',e.displayText(),"\n    </li>\n  ")}),__p.push("\n</ol>\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/telephony/call_queue_view"]=function(obj){var __p=[];with(obj||{})__p.push('<div class="label">Queue</div><div class="badge">',queue.size,"</div>\n\n");return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/telephony/conversation_buttons_view"]=function(obj){var __p=[];with(obj||{})__p.push('<button class="initiate-conversation ',conversation.uiShowCall(),'" ',conversation.uiDisableCall(),' >\n  <span class="text">Call</span>\n  <span class="icon-spinner float-right ',conversation.uiShowCallSpinner(),'"></span>\n</button>\n\n<button class="initiate-hold ',conversation.uiShowHold(),'" ',conversation.uiDisableHold(),' >\n  <span class="text">Hold</span>\n  <span class="icon-spinner float-right ',conversation.uiShowHoldSpinner(),'"></span>\n</button>\n\n<button class="resume ',conversation.uiShowResume(),'" ',conversation.uiDisableResume(),' >\n  <span class="text">Resume</span>\n  <span class="icon-spinner float-right ',conversation.uiShowResumeSpinner(),'"></span>\n</button>\n\n<button class="show-agents ',conversation.uiShowTransfer(),'" ',conversation.uiDisableTransfer(),'>\n  <span class="text">Transfer</span>\n  <span class="icon-user"></span>\n</button>\n\n<button class="cancel-transfer ',conversation.uiShowCancelTransfer(),'">\n  <span class="text">Cancel Transfer</span>\n</button>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/telephony/conversation_view"]=function(obj){var __p=[];with(obj||{})__p.push('<div class="conversation-controls">\n  <form action="#">\n    <input type="text" class="number" name="number" ',conversation.uiDisableCall(),'  value="',conversation.get("to"),'" />\n  </form>\n\n  <div class="friendly-message">',friendlyMessage,'</div>\n</div>\n\n<div class="transfer-wrapper">\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/telephony/status_view"]=function(obj){var __p=[];with(obj||{})__p.push('<button class="agent-status ',agent.status(),'" ',agent.disabled(),' >\n  <span class="caps">',agent.humanizedStatus(),'</span>\n  <span class="icon-spinner float-right ',agent.display(),'"></span>\n</button>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/telephony/transfer_view"]=function(obj){var __p=[];with(obj||{})__p.push('<div id="telephony-transfer">\n  <div>Transfer to...</div>\n\n  <form action="#">\n    <div class="agent-input">\n      <span class="',agentStatus,'"></span>\n      <input type="text" name="selected_agent"\n        value="',transfer.selectedAgentDisplayText(),'"\n        ',transfer.uiDisabledFilter(),' />\n      <span class="backspace ',transfer.uiShowClearSelectedAgent(),'"></span>\n    </div>\n\n    <span class="controls ',transfer.uiShowTransferControl(),' ">\n      <span class="transfer-type">\n        <label for="transfer_type_one_step" id="one-step-transfer">one step</label>\n        <input ',transfer.uiCheckedOneStep(),'\n          id="transfer_type_one_step"\n          name="transfer_type"\n          type="radio"\n          value="one_step" >\n      </span>\n      <span class="transfer-type">\n        <label for="transfer_type_two_step" id="two-step-transfer">two step</label>\n        <input ',transfer.uiCheckedTwoStep()," ",transfer.uiDisabledTwoStep(),'\n          id="transfer_type_two_step"\n          name="transfer_type"\n          type="radio"\n          value="two_step" >\n      </span>\n      <button class="initiate-transfer">\n        <span class="text">Initiate Transfer</span>\n      </button>\n    </span>\n\n  </form>\n\n  <div class="agents-wrapper ',transfer.uiShowAgentsList(),'"></div>\n</div>\n');return __p.join("")}}.call(this),function(){this.JST||(this.JST={}),this.JST["templates/telephony/twilio_client_view"]=function(obj){var __p=[];with(obj||{})__p.push('<button class="answer ',device.uiShowAnswerButton(),'" ',device.uiDisableAnswerButton(),' >\n  <span class="text">Answer</span>\n  <span class="icon-phone"></span>\n</button>\n\n<button class="hangup ',device.uiShowHangupButton(),'" ',device.uiDisableHangupButton(),' >\n  <span class="text">Hangup</span>\n  <span class="icon-cancel-circle"></span>\n</button>\n\n');return __p.join("")}}.call(this),window.Zest=window.Zest||{},window.Zest.Telephony=window.Zest.Telephony||{},window.Zest.Telephony.Config=window.Zest.Telephony.Config||{},window.Zest.Telephony.Models={},window.Zest.Telephony.Collections={},window.Zest.Telephony.Views={},Zest.Telephony.Config={PUSHER_APP_KEY:"05a727cb51dd5bd1c402",STYLESHEET_PATH:"/assets/telephony/widget.css",BASE_PATH:"/zestphone",AGENT_PATH:"/zestphone/agents",TWILIO_CLIENT_ENABLED:"twilio_client"==$("#telephony-widget").data("agent_phone_type"),TWILIO_CLIENT_URL:"//static.twilio.com/libs/twiliojs/1.1/twilio.min.js",TWILIO_CLIENT_TOKEN_PATH:"/zestphone/twilio_client/token",CONVERSATION_PATH:"/zestphone/conversations"},Pusher.channel_auth_endpoint="/zestphone/signals/agents/presences/authenticate",Zest.Telephony.Push=function(e){return{init:function(t){this.lastCallEventId=0,this.lastQueueChangeEventId=0,this.lastStatusChangeEventAt=0;var n=e("#telephony-widget");this.socket=t||new Pusher(Zest.Telephony.Config.PUSHER_APP_KEY,{auth:{params:{csr_id:n.data("csr_id"),csr_default_status:n.data("agent_default_status")}}});var i=n.data("csr_id"),s=(this.socket.subscribe("presence-"+i),this.socket.subscribe("csrs"));s.bind("QueueChange",this._emitQueueChangeEvent("telephony:QueueChange"));var o=this.socket.subscribe("csrs-"+i);o.bind("statusChange",this._emitStatusEvent("telephony:csrDidChangeStatus")),o.bind("InitializeWidget",this._emitEvent("telephony:InitializeWidget")),o.bind("Connect",this._emitCallEvent("telephony:Connect")),o.bind("Answer",this._emitCallEvent("telephony:Answer")),o.bind("Conference",this._emitCallEvent("telephony:Conference")),o.bind("Start",this._emitCallEvent("telephony:Start")),o.bind("Busy",this._emitCallEvent("telephony:Busy")),o.bind("NoAnswer",this._emitCallEvent("telephony:NoAnswer")),o.bind("CallFail",this._emitCallEvent("telephony:CallFail")),o.bind("Terminate",this._emitCallEvent("telephony:Terminate")),o.bind("InitiateTwoStepTransfer",this._emitCallEvent("telephony:InitiateTwoStepTransfer")),o.bind("FailTwoStepTransfer",this._emitCallEvent("telephony:FailTwoStepTransfer")),o.bind("CompleteTwoStepTransfer",this._emitCallEvent("telephony:CompleteTwoStepTransfer")),o.bind("CustomerLeftTwoStepTransfer",this._emitCallEvent("telephony:CustomerLeftTwoStepTransfer")),o.bind("LeaveTwoStepTransfer",this._emitCallEvent("telephony:LeaveTwoStepTransfer")),o.bind("InitiateOneStepTransfer",this._emitCallEvent("telephony:InitiateOneStepTransfer")),o.bind("CompleteOneStepTransfer",this._emitCallEvent("telephony:CompleteOneStepTransfer")),o.bind("CompleteHold",this._emitCallEvent("telephony:CompleteHold")),o.bind("CompleteResume",this._emitCallEvent("telephony:CompleteResume")),o.bind("FailOneStepTransfer",this._emitCallEvent("telephony:FailOneStepTransfer")),o.bind("LeaveVoicemail",this._emitCallEvent("telephony:LeaveVoicemail")),o.bind("QueueChange",this._emitQueueChangeEvent("telephony:QueueChange"))},_emitEvent:function(t){return function(n){e(document).trigger(t,n)}},_emitQueueChangeEvent:function(t){var n=this;return function(i){n.lastQueueChangeEventId<i.event_id&&(e(document).trigger(t,i),n.lastQueueChangeEventId=i.event_id)}},_emitStatusEvent:function(t){var n=this;return function(i){n.lastStatusChangeEventAt<i.timestamp&&(e(document).trigger(t,i),n.lastStatusChangeEventAt=i.timestamp)}},_emitCallEvent:function(t){var n=this;return function(i){n.lastCallEventId<i.event_id&&(e(document).trigger(t,i),n.lastCallEventId=i.event_id)}}}}(jQuery),Zest.Telephony.Models.Device=Backbone.Model.extend({defaults:{state:"disabled_by_default"},state:function(){return this.get("state")},uiShowAnswerButton:function(){var e=["ready","error","disconnect","incoming","answering"];return _.contains(e,this.state())?"":"hidden"},uiDisableAnswerButton:function(){var e=["incoming"];return _.contains(e,this.state())?"":"disabled"},uiShowHangupButton:function(){var e=["connect"];return _.contains(e,this.state())?"":"hidden"},uiDisableHangupButton:function(){var e=["connect"];return _.contains(e,this.state())?"":"disabled"}}),Zest.Telephony.Models.Agent=Backbone.Model.extend({urlRoot:Zest.Telephony.Config.AGENT_PATH,defaults:{status:"loading...",in_transition:!1},url:function(){return this.urlRoot+"/"+this.get("csr_id")},statusUrl:function(){return this.url()+"/status"},status:function(){return this.get("status")},displayText:function(){return this.get("csr_type")+" "+this.get("name")+" x"+this.get("phone_ext")},toggleAvailable:function(){this.updateStatus("toggle_available")},updateStatus:function(e){var t={};t.event=e||"not_available",this.set({in_transition:!0}),$.ajax(this.statusUrl(),{data:t,type:"PUT"}).done($.proxy(this.done,this)).fail($.proxy(this.fail,this)).always($.proxy(this.always,this))},isValid:function(e){e=e||{},$.ajax(this.url(),{data:this.toJSON(),type:"PUT"}).done(e.done_callback).fail(e.fail_callback)},disabled:function(){return this.onACall()||this.offline()||this.inTransition()?"disabled":""},display:function(){return this.inTransition()||this.loading()?"display":""},inTransition:function(){return this.get("in_transition")},onACall:function(){return"on_a_call"===this.get("status")},offline:function(){return"offline"===this.get("status")},available:function(){return"available"===this.get("status")},notAvailable:function(){return"not_available"===this.get("status")},loading:function(){return"loading..."===this.get("status")},humanizedStatus:function(){var e=this.get("status").replace(/_/g," ");return e.substr(0,1).toUpperCase()+e.substr(1)},done:function(e){this.set(e,{silent:!0})},always:function(){this.set({in_transition:!1})},fail:function(e,t){"object"==typeof console&&"function"==typeof console.log&&console.log("Unable to update the status: "+t)}}),Zest.Telephony.Models.Transfer=Backbone.Model.extend({url:function(){return Zest.Telephony.Config.BASE_PATH+"/conversations/"+this.get("conversationId")+"/transfers"},defaults:{transferType:"two_step"},toJSON:function(){var e=this.get("selectedAgent");return{transfer_id:e.get("csr_id"),transfer_type:this.get("transferType")}},selectedAgentDisplayText:function(){var e=this.get("selectedAgent");return e?e.displayText():""},uiShowClearSelectedAgent:function(){return this.get("selectedAgent")?"":"hidden"},uiDisabledFilter:function(){return this.get("selectedAgent")?"disabled":""},uiShowAgentsList:function(){return this.get("selectedAgent")?"hidden":""},uiDisabledTwoStep:function(){var e=this.get("selectedAgent");return e&&e.available()?"":"disabled"},uiCheckedOneStep:function(){var e=this.get("selectedAgent");return e&&e.available()?"":"checked"},uiCheckedTwoStep:function(){var e=this.get("selectedAgent");return e&&e.available()?"checked":""},uiShowTransferControl:function(){return this.get("selectedAgent")?"":"hidden"}}),Zest.Telephony.Models.Conversation=Backbone.Model.extend({urlRoot:Zest.Telephony.Config.CONVERSATION_PATH,defaults:{state:"disabled_by_default"},initialize:function(){this.enabledHoldStates=["in_progress","in_progress_two_step_transfer"],this.disabledHoldStates=["two_step_transferring","initiating_hold","agents_only"],this.enabledResumeStates=["in_progress_hold","in_progress_two_step_transfer_hold"],this.disabledResumeStates=["initiating_resume","initiating_two_step_transfer_resume","two_step_transferring_hold"]},create:function(){var e={loan_id:this.get("loanId"),from:this.get("from"),from_id:this.get("fromId"),from_type:"csr",to:this.get("to"),to_id:this.get("toId"),to_type:this.get("toType"),owner:this.get("owner")};this.set({state:"connecting"}),$.ajax(this.url(),{data:e,type:"POST"}).done($.proxy(this.createSuccess,this)).fail($.proxy(this.createFail,this))},hold:function(){var e=this.get("state"),t="initiating_hold";this.set({state:t}),$.ajax(this.url()+"/hold",{type:"POST"}).done($.proxy(this.holdResumeSuccess,this)).fail($.proxy(this.holdResumeFail(e,t),this))},resume:function(){var e=this.get("state"),t="initiating_resume";this.set({state:t}),$.ajax(this.url()+"/resume",{type:"POST"}).done($.proxy(this.holdResumeSuccess,this)).fail($.proxy(this.holdResumeFail(e,t),this))},holdResumeSuccess:function(e){this.set(e)},holdResumeFail:function(e,t){return function(n){var i=JSON.parse(n.responseText),s={error:i.errors[0],oldState:e,newState:t};$(document).trigger("holdResumeFail",s)}},uiDisableCall:function(){return this.get("callingDisabled")?"disabled":this._enabledForStates(["not_initiated","terminated"])},uiShowCall:function(){var e=["not_initiated","connecting","terminated"];return this._shownForStates(e)},uiDisableTransfer:function(){var e=["in_progress","in_progress_hold"];return this._enabledForStates(e)},uiShowTransfer:function(){if(this.get("isCancelable"))return"hidden";var e=["in_progress","one_step_transferring","two_step_transferring","two_step_transferring_hold","initiating_two_step_transfer_resume","initiating_two_step_transfer_hold","in_progress_two_step_transfer_hold","in_progress_two_step_transfer","initiating_hold","in_progress_hold","initiating_resume","agents_only"];return this._shownForStates(e)},uiShowCancelTransfer:function(){return this.get("isCancelable")?"":"hidden"},uiShowResume:function(){var e=this.enabledResumeStates.concat(this.disabledResumeStates);return this._shownForStates(e)},uiDisableResume:function(){return this._disabledIf(this._statesIn(this.disabledResumeStates)||!this.get("owner"))},uiShowHold:function(){var e=this.enabledHoldStates.concat(this.disabledHoldStates);return this._shownForStates(e)},uiDisableHold:function(){return this._disabledIf(this._statesIn(this.disabledHoldStates)||!this.get("owner"))},uiShowCallSpinner:function(){return this._displayedForStates(["connecting"])},uiShowHoldSpinner:function(){return this._displayedForStates(["initiating_hold"])},uiShowResumeSpinner:function(){return this._displayedForStates(["initiating_resume"])
},state:function(){return this.get("state")},createSuccess:function(e){$(document).trigger("telephony:conversationCreated",e),this.set(e)},createFail:function(e){var t=JSON.parse(e.responseText);$(document).trigger("callFailed",t.errors[0])},fail:function(e,t){"object"==typeof console&&"function"==typeof console.log&&console.log("Unable to complete the request: "+t)},isValid:function(){return this._isValidPhoneNumberFormat()?this._isValidCallee()?!0:!1:!1},_disabledIf:function(e){return e?"disabled":""},_statesIn:function(e){return _.contains(e,this.state())},_disabledForStates:function(e){return this._disabledIf(this._statesIn(e))},_enabledForStates:function(e){return _.contains(e,this.state())?"":"disabled"},_shownForStates:function(e){return _.contains(e,this.state())?"":"hidden"},_displayedForStates:function(e){return _.contains(e,this.state())?"display":""},_isValidPhoneNumberFormat:function(){var e=this._normalizePhoneNumber(this.get("to"));return 10!==e.length?(this.errorMessage="Please enter a 10-digit phone number",!1):!0},_isValidCallee:function(){var e=this._normalizePhoneNumber(this.get("from")),t=this._normalizePhoneNumber(this.get("to"));return e===t?(this.errorMessage="Please input a customer phone number",!1):!0},_normalizePhoneNumber:function(e){var t=e||"",n=t.toString().replace(/\D/g,"");return"1"===n[0]&&(n=n.slice(1)),n}}),Zest.Telephony.Collections.Agents=Backbone.Collection.extend({url:Zest.Telephony.Config.AGENT_PATH,model:Zest.Telephony.Models.Agent}),Zest.Telephony.Views.AgentsView=Backbone.View.extend({template:JST["templates/telephony/agents_view"],events:{"click li":"setSelectedAgent"},initialize:function(e){this.currentAgentId=e.currentAgentId,e.agents?this.agents=e.agents:(this.agents=new Zest.Telephony.Collections.Agents,this.agents.fetch({data:{csr_id:this.currentAgentId}})),this.agents.bind("reset",this.render,this)},filter:function(e){if(this.allAgentsJSON||(this.allAgentsJSON=this.agents.toJSON()),""===e)this.agents.reset(this.allAgentsJSON);else{var t=_.filter(this.allAgentsJSON,function(t){var n=t.csr_type+" "+t.name+" "+t.phone_ext,i=_.map(e.split(" "),function(e){return e.trim()});return _.reduce(i,function(e,t){var i=new RegExp(t,"i");return e&&i.test(n)},!0)});this.agents.reset(t)}},selectBestMatched:function(){var e=this.agents.at(0);this.triggerAgentSelection(e)},triggerAgentSelection:function(e){$(this.el).trigger("agentDidSelect",e)},setSelectedAgent:function(e){var t=$(e.currentTarget).data("id"),n=this.agents.get(t);this.triggerAgentSelection(n)},render:function(){var e=this,t=this.agents.filter(function(t){return!(t.get("csr_id")==e.currentAgentId)});this.agents.reset(t,{silent:!0});var n=this.template({agents:this.agents});this.el.html(n)}}),Zest.Telephony.Views.ApplicationView=Backbone.View.extend({el:"#telephony-widget",initialize:function(){if(!this.el){var e=this.options.logger||console;return e.log("No root element to create the telephony widget"),void 0}Zest.Telephony.Push.init()},disableCallControl:function(e){this.widgetView.disableCallControl(e)},render:function(){var e=$(this.el);return this.widgetView=new Zest.Telephony.Views.WidgetView({loanId:e.data("loan_id"),csrId:e.data("csr_id"),agentNumber:e.data("agent_phone_number")}),e.append(this.widgetView.render().el),this}}),Zest.Telephony.Application=function(){var e;return{init:function(e){$("#telephony-widget");e=e||this.setupAgent(),e.isValid({done_callback:$.proxy(this.done,this),fail_callback:$.proxy(this.fail,this)})},setupAgent:function(){var e=$("#telephony-widget");return new Zest.Telephony.Models.Agent({csr_id:e.data("csr_id"),csr_type:e.data("csr_type"),csr_generate_caller_id:e.data("agent_generate_caller_id"),csr_name:e.data("agent_name"),csr_phone_number:e.data("agent_phone_number"),csr_phone_ext:e.data("agent_phone_ext"),csr_sip_number:e.data("agent_sip_number"),csr_call_center_name:e.data("agent_call_center_name"),csr_phone_type:e.data("agent_phone_type")||"",csr_transferable_agents:JSON.stringify(e.data("agent_transferable_agents")||[])})},getInstance:function(){return e||(e=new Zest.Telephony.Views.ApplicationView),e},done:function(e){this.getInstance().render(),$(document).trigger("telephony:WidgetReady",{conversation_id:e.conversation_id})},fail:function(e){var t=JSON.parse(e.responseText);$("#telephony-widget").text(t.errors)}}}(),Zest.Telephony.Views.CallQueueView=Backbone.View.extend({className:"call-queue-wrapper",template:JST["templates/telephony/call_queue_view"],initialize:function(){this.queue={size:99},$(document).bind("telephony:QueueChange",$.proxy(this.updateQueue,this))},updateQueue:function(e,t){this.queue.size=t.size,this.render()},render:function(){return $(this.el).html(this.template({queue:this.queue})),this}}),Zest.Telephony.Views.ConversationButtonsView=Backbone.View.extend({className:"buttons-wrapper",template:JST["templates/telephony/conversation_buttons_view"],initialize:function(e){this.conversation=e.conversation,this.conversation.bind("change",$.proxy(this.render,this))},render:function(){return $(this.el).html(this.template({conversation:this.conversation})),this}}),Zest.Telephony.Views.ConversationView=Backbone.View.extend({className:"conversation-wrapper",events:{"click button.initiate-conversation":"createConversation","click button.cancel-transfer":"cancelTransfer","click button.initiate-hold":"hold","click button.resume":"resume","click button.show-agents":"openTransferView"},template:JST["templates/telephony/conversation_view"],initialize:function(){this.setupNewConversation(),$(document).bind("transferInitiated",$.proxy(this.cancelTransfer,this)).bind("callFailed",$.proxy(this.displayCallFailedMessage,this)).bind("holdResumeFail",$.proxy(this.displayHoldResumeFailedMessage,this)).bind("transferFailed",$.proxy(this.displayTransferFailedMessage,this)).bind("telephony:InitializeWidget",$.proxy(this.onInitializeWidget,this)).bind("telephony:ClickToCall",$.proxy(this.onClickToCall,this)).bind("telephony:Connect",$.proxy(this.onConnect,this)).bind("telephony:Start",$.proxy(this.onStart,this)).bind("telephony:Busy telephony:NoAnswer telephony:CallFail telephony:Terminate",$.proxy(this.onCallEnded,this)).bind("telephony:InitiateOneStepTransfer",$.proxy(this.onInitiateOneStepTransfer,this)).bind("telephony:CompleteOneStepTransfer",$.proxy(this.onCompleteOneStepTransfer,this)).bind("telephony:FailOneStepTransfer",$.proxy(this.onFailOneStepTransfer,this)).bind("telephony:InitiateTwoStepTransfer",$.proxy(this.onInitiateTwoStepTransfer,this)).bind("telephony:CompleteTwoStepTransfer",$.proxy(this.onCompleteTwoStepTransfer,this)).bind("telephony:CustomerLeftTwoStepTransfer",$.proxy(this.onCustomerLeftTwoStepTransfer,this)).bind("telephony:LeaveTwoStepTransfer",$.proxy(this.onLeaveTwoStepTransfer,this)).bind("telephony:CompleteHold",$.proxy(this.onCompleteHold,this)).bind("telephony:CompleteResume",$.proxy(this.onCompleteResume,this)).bind("telephony:FailTwoStepTransfer",$.proxy(this.onFailTwoStepTransfer,this))},hold:function(){this.conversation.hold()},resume:function(){this.conversation.resume()},displayCallFailedMessage:function(e,t){this.friendlyMessage=t,this.conversation.set({state:"not_initiated"})},displayTransferFailedMessage:function(e,t){this.friendlyMessage=t,this.conversation.set({state:"in_progress"})},displayHoldResumeFailedMessage:function(e,t){this.friendlyMessage=t.error,this.conversation.get("state")===t.newState?this.conversation.set({state:t.oldState}):this.render()},onInitializeWidget:function(){this.friendlyMessage="",this.conversation.set({state:"not_initiated"})},disableCallControl:function(e){this.conversation.set({callingDisabled:e.callingDisabled}),this.render()},setupNewConversation:function(){this.conversation=new Zest.Telephony.Models.Conversation({loanId:this.options.loanId,from:this.options.agentNumber,fromId:this.options.fromId}),this.conversation.bind("change:state",$.proxy(this.render,this))},showCancelTransfer:function(){this.conversation.set({isCancelable:!0})},cancelTransfer:function(){$(this.el).animate({height:"50px"}),this.conversation.set({isCancelable:!1}),this.transferView=null,this.render()},createConversation:function(e){this.setupNewConversation(),e.preventDefault();var t=this.$("input[name=number]").val();this.conversation.set({to:t,state:"not_initiated"}),this.conversation.isValid()?(this.friendlyMessage="",this.conversation.create()):(this.friendlyMessage=this.conversation.errorMessage,this.render())},onClickToCall:function(e,t){this.conversation.set({to:t.to,toId:t.to_id,toType:t.to_type}),this.friendlyMessage=t.callee_name||"",this.render()},onConnect:function(e,t){this.friendlyMessage="Ringing",this.setConversationData(t),this.render()},setConversationData:function(e){this.conversation.set({to:e.number,state:e.conversation_state,id:e.conversation_id,owner:e.owner})},openTransferView:function(e){e.preventDefault(),this.showAgents()},showAgents:function(){this.showCancelTransfer(),$(this.el).animate({height:"100px"});var e=this.$(".transfer-wrapper"),t=this.conversation.get("id");this.transferView?(this.transferView.el=e,this.transferView.conversationId=t,this.transferView.rebindEvents()):this.transferView=new Zest.Telephony.Views.TransferView({el:e,conversationId:t}),this.transferView.render()},onStart:function(e,t){this.friendlyMessage="Connected",this.setConversationData(t),this.render()},onCallEnded:function(e,t){this.friendlyMessage="Call Ended",this.conversation.set({to:"",state:"terminated",id:t.conversation_id,owner:t.owner,isCancelable:!1}),this.render(),$(this.el).animate({height:"50px"}),this.$(".friendly-message").animate({opacity:0},this.friendlyMessageFadeOutTime||5e3)},onInitiateOneStepTransfer:function(e,t){t.transferrer||(this.friendlyMessage="1-step transfer from "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext,this.setConversationData(t),this.render())},onCompleteOneStepTransfer:function(e,t){this.friendlyMessage="Connected",this.setConversationData(t),this.render()},onFailOneStepTransfer:function(e,t){return t.transferrer?(this.conversation.set({state:"terminated"}),void 0):(this.friendlyMessage="Missed 1-step transfer from "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext,this.conversation.set({id:t.conversation_id,state:"terminated",to:t.number,owner:t.owner}),this.render(),void 0)},onInitiateTwoStepTransfer:function(e,t){this.friendlyMessage=t.transferrer?"Ringing "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext:"2-step transfer from "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext,this.conversation.set({disabledTransfer:!0,state:t.conversation_state,to:t.number,owner:t.owner}),this.render()},onFailTwoStepTransfer:function(e,t){t.transferrer?(this.friendlyMessage="No Answer - "+t.agent_name+" x"+t.agent_ext,this.nextFriendlyMessage="Connected",this.setConversationData(t),this.render(),this.$(".friendly-message").animate({opacity:0},{duration:this.friendlyMessageFadeOutTime||5e3,complete:$.proxy(this.afterFriendlyMessageDecay,this)})):(this.friendlyMessage="Missed 2-step transfer from "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext,this.conversation.set({to:t.number,state:"terminated",id:t.conversation_id,owner:t.owner}),this.render())},afterFriendlyMessageDecay:function(){this.nextFriendlyMessage&&(this.friendlyMessage=this.nextFriendlyMessage,this.nextFriendlyMessage=null,this.render())},onCompleteTwoStepTransfer:function(e,t){this.friendlyMessage="Connected to "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext,this.setConversationData(t),this.render()},onCustomerLeftTwoStepTransfer:function(e,t){this.friendlyMessage="Connected to "+t.agent_type+" - "+t.agent_name+" x"+t.agent_ext,this.setConversationData(t),this.render()},onLeaveTwoStepTransfer:function(e,t){this.friendlyMessage="Connected",this.setConversationData(t),this.render()},onCompleteHold:function(e,t){this.setConversationData(t)},onCompleteResume:function(e,t){this.setConversationData(t)},render:function(){var e=this.template({conversation:this.conversation,friendlyMessage:this.friendlyMessage});return $(this.el).html(e),this.buttonsView=new Zest.Telephony.Views.ConversationButtonsView({conversation:this.conversation}),this.$("form").append(this.buttonsView.render().el),this.conversation.get("isCancelable")&&this.showAgents(),this}}),Zest.Telephony.Views.StatusView=Backbone.View.extend({className:"agent-status-wrapper",events:{"click button":"toggleAvailable"},template:JST["templates/telephony/status_view"],initialize:function(e){this.agent=new Zest.Telephony.Models.Agent({csr_id:e.csrId}),this.agent.bind("change",this.render,this),$(document).bind("telephony:csrDidChangeStatus",$.proxy(this.renderStatus,this)),$(document).bind("telephony:csrNotAvailable",$.proxy(this.setNotAvailable,this)),$(document).bind("telephony:toggleCsrStatus",$.proxy(this.toggleAvailable,this))},toggleAvailable:function(e){e.preventDefault(),this.agent.toggleAvailable()},setNotAvailable:function(){this.agent.updateStatus()},renderStatus:function(e,t){this.agent.set(t)},render:function(){return $(this.el).html(this.template({agent:this.agent})),this}}),Zest.Telephony.Views.TransferView=Backbone.View.extend({template:JST["templates/telephony/transfer_view"],events:{submit:"selectBestMatchedAgent","keyup input[name=selected_agent]":"filterAgents","click button.initiate-transfer":"initiateTransfer","click .backspace":"clearSelectedAgent","click input[name=transfer_type]":"setTransferType"},initialize:function(e){this.transfer=new Zest.Telephony.Models.Transfer({conversationId:e.conversationId}),$(this.el).bind("agentDidSelect",$.proxy(this.setSelectedAgent,this))},rebindEvents:function(){this.delegateEvents(this.events),$(this.el).bind("agentDidSelect",$.proxy(this.setSelectedAgent,this))},selectBestMatchedAgent:function(){return this.agentsView.selectBestMatched(),!1},clearSelectedAgent:function(){this.transfer.set({selectedAgent:null}),this.render()},filterAgents:function(e){if(13!=e.keyCode){var t=$(e.currentTarget).val();this.search(t)}},search:function(e){this.agentsView.filter(e)},setSelectedAgent:function(e,t){this.transfer.set({selectedAgent:t}),this.render()},initiateTransfer:function(e){e.preventDefault(),e.stopPropagation();var t=this.$("form input[name=transfer_type]:checked").val();return this.transfer.save({transferType:t},{success:function(){$(document).trigger("transferInitiated")},error:function(e,t){var n=JSON.parse(t.responseText);$(document).trigger("transferFailed",n.errors[0])}}),!1},setTransferType:function(e){this.transfer.set({transferType:$(e.currentTarget).val()})},render:function(){var e=this.transfer.get("selectedAgent"),t="undefined"==typeof e||null===e?"":"icon-user "+e.get("status"),n=this.template({transfer:this.transfer,agentStatus:t});this.el.html(n),this.transfer.get("selectedAgent")||(this.agentsView=new Zest.Telephony.Views.AgentsView({el:$(".agents-wrapper"),currentAgentId:$("#telephony-widget").data("csr_id")}),this.agentsView.render())}}),Zest.Telephony.Views.TwilioClientView=Backbone.View.extend({className:"twilio-client-wrapper",events:{"click button.answer":"deviceAnswer","click button.hangup":"deviceHangup"},template:JST["templates/telephony/twilio_client_view"],initialize:function(e){this.agent=e.agent,this.device=new Zest.Telephony.Models.Device,this.device.bind("change:state",$.proxy(this.render,this)),$(document).bind("telephony:Answer",$.proxy(this.onAnswer,this)).bind("telephony:Start",$.proxy(this.onAnswer,this)).bind("telephony:Conference",$.proxy(this.onAnswer,this)).bind("telephony:CompleteOneStepTransfer",$.proxy(this.onAnswer,this)).bind("telephony:CompleteTwoStepTransfer",$.proxy(this.onAnswer,this)).bind("telephony:Busy telephony:NoAnswer telephony:CallFail telephony:Terminate",$.proxy(this.onCallEnded,this)),this.tokenPath=Zest.Telephony.Config.TWILIO_CLIENT_TOKEN_PATH;var t={csr_id:e.csrId};$.ajax(this.tokenPath,{type:"GET",data:t}).done($.proxy(this.loadToken,this)).fail($.proxy(this.logFail,this))},loadToken:function(e){var t=e.token;this.setupTwilioClient(t)},logFail:function(){"object"==typeof console&&"function"==typeof console.log&&console.log("Failed to load capability token")},setupTwilioClient:function(e){Twilio.Device.setup(e,{debug:!1}),Twilio.Device.ready($.proxy(this.deviceReady,this)),Twilio.Device.error($.proxy(this.deviceError,this)),Twilio.Device.incoming($.proxy(this.deviceIncoming,this)),Twilio.Device.connect($.proxy(this.deviceConnect,this)),Twilio.Device.disconnect($.proxy(this.deviceDisconnect,this))},deviceReady:function(){this.device.set({state:"ready"})},deviceError:function(){this.device.set({state:"error"})},deviceIncoming:function(e){this.connection=e,this.device.set({state:"incoming"})},deviceConnect:function(){this.device.set({state:"connect"})},deviceDisconnect:function(){this.device.set({state:"disconnect"})},deviceAnswer:function(){this.connection.accept(),this.disallowBrowserReload(),this.device.set({state:"answering"})},deviceHangup:function(){Twilio.Device.disconnectAll(),this.allowBrowserReload(),this.device.set({state:"ready"})},onAnswer:function(){this.device.set({state:"connect"}),this.render()},onCallEnded:function(){this.device.set({state:"ready"}),this.render()},disallowBrowserReload:function(){this.currentBeforeUnload=window.onbeforeunload;var e=this;$(window).bind("beforeunload",function(){return e.agent.onACall()?"You are ON A CALL. If you leave this page your call will be terminated.":void 0})},allowBrowserReload:function(){$(window).unbind("beforeunload"),window.onbeforeunload=this.currentBeforeUnload},render:function(){return $(this.el).html(this.template({device:this.device})),this}}),Zest.Telephony.Views.WidgetView=Backbone.View.extend({className:"telephony-widget-container",disableCallControl:function(e){this.conversationView.disableCallControl(e)},loadTwilioClient:function(){this.twilioClientView=new Zest.Telephony.Views.TwilioClientView({csrId:this.options.csrId,agent:this.statusView.agent}),$(this.el).append(this.twilioClientView.render().el)},logFail:function(){"object"==typeof console&&"function"==typeof console.log&&console.log("Failed to load Twilio Client")},render:function(){return $("<link/>",{rel:"stylesheet",type:"text/css",href:Zest.Telephony.Config.STYLESHEET_PATH}).appendTo("head"),this.callQueueView=new Zest.Telephony.Views.CallQueueView,$(this.el).append(this.callQueueView.render().el),this.statusView=new Zest.Telephony.Views.StatusView({csrId:this.options.csrId}),$(this.el).append(this.statusView.render().el),this.conversationView=new Zest.Telephony.Views.ConversationView({loanId:this.options.loanId,agentNumber:this.options.agentNumber,fromId:this.options.csrId}),$(this.el).append(this.conversationView.render().el),Zest.Telephony.Config.TWILIO_CLIENT_ENABLED&&$.getScript(Zest.Telephony.Config.TWILIO_CLIENT_URL).done($.proxy(this.loadTwilioClient,this)).fail($.proxy(this.logFail,this)),this}});